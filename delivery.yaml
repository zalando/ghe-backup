build_steps:

- desc: "setup the environment"
  cmd: |
    apt-get update
    apt-get install -y python3-dev python-pip #python3-pip
    curl -sSL https://delivery.cloud.zalando.com/utils/ensure-docker | sh
    sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 10
    python --version
    pip install --upgrade pip
    pip --version
    pip install -r python/requirements.txt

- desc: "run tests"
  cmd: |
    python --version
    nosetests -w python

- desc: "build and push docker images"
  cmd: |
    python --version
    IMAGE=pierone.stups.zalan.do/machinery/ghe-backup:${CDP_BUILD_VERSION}
    ### bus one
    DOCKERFILE=DockerfileBus
    docker build -t $IMAGE -f $DOCKERFILE .
    IS_PR_BUILD=${CDP_PULL_REQUEST_NUMBER+true}
    if [ "$IS_PR_BUILD" = true ]; then
      echo "Image not pushed because the build is not a push to master"
    else
      docker push $IMAGE
    fi
    ### automata one
    DOCKERFILE=DockerfileAutomata
    docker build -t $IMAGE -f $DOCKERFILE .
    IS_PR_BUILD=${CDP_PULL_REQUEST_NUMBER+true}
    if [ "$IS_PR_BUILD" = true ]; then
      echo "Image not pushed because the build is not a push to master"
    else
      docker push $IMAGE
    fi
